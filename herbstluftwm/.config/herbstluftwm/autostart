#!/usr/bin/zsh

herbstclient emit_hook reload

herbstclient set frame_gap 4
herbstclient set frame_padding 0
herbstclient set window_gap 0
herbstclient set snap_distance 10
herbstclient set snap_gap 0
herbstclient set mouse_recenter_gap 0
herbstclient set frame_border_active_color '#1e1e1e'
herbstclient set frame_border_normal_color '#1e1e1e'
herbstclient set frame_border_inner_color '#1e1e1e'
herbstclient set frame_bg_active_color '#e3c472'
herbstclient set frame_bg_normal_color '#424242'
herbstclient set frame_bg_transparent 1
herbstclient set frame_transparent_width 5
herbstclient set frame_border_width 1
herbstclient set frame_border_inner_width 0
herbstclient set focus_crosses_monitor_boundaries 1
herbstclient set raise_on_focus 0
herbstclient set raise_on_focus_temporarily 0
herbstclient set raise_on_click 1
herbstclient set window_border_width 3
herbstclient set window_border_inner_width 1
herbstclient set window_border_active_color '#30c798'
herbstclient set window_border_normal_color '#424242'
herbstclient set window_border_urgent_color '#e32791'
herbstclient set window_border_inner_color '#1e1e1e'
herbstclient set always_show_frame 0
herbstclient set frame_normal_opacity 100
herbstclient set frame_active_opacity 100
herbstclient set default_frame_layout 3
herbstclient set default_direction_external_only 0 ### TODO
herbstclient set gapless_grid 1
herbstclient set smart_frame_surroundings 1
herbstclient set smart_window_surroundings 0
herbstclient set focus_follows_mouse 0
herbstclient set focus_stealing_prevention 0
herbstclient set swap_monitors_to_get_tag 1
herbstclient set auto_detect_monitors 0 ### TODO
herbstclient set tree_style '├│ ├└──┬'
herbstclient set update_dragged_clients 1

herbstclient keyunbind --all

herbstclient keybind Mod4-Shift-q quit
herbstclient keybind Mod4-Shift-r reload
herbstclient keybind Mod4-q close

TERMINALCMD=(kitty -1 --listen-on unix:@mykitty)
MAX_BRIGHTNESS=$(</sys/class/backlight/intel_backlight/max_brightness)

herbstclient keybind Mod4-Return spawn $TERMINALCMD
herbstclient keybind Mod4-p spawn rofi -show run
herbstclient keybind Mod4+ssharp spawn $SHELL -c "rofi -dmenu -i -p Emoji -input $HOME/.local/share/emoji.txt | awk '{printf \$1}' | xsel -ib"
herbstclient keybind Mod4+F1 spawn $SHELL -c "mupdf-gl =(man -Tpdf \$(apropos . | rofi -dmenu -i -p mansplain | awk '{gsub(/[()]/,\"\"); print \$2\" \"\$1}'))"
herbstclient keybind XF86AudioRaiseVolume spawn amixer sset Master 5%+ unmute
herbstclient keybind XF86AudioLowerVolume spawn amixer sset Master 5%- unmute
herbstclient keybind XF86AudioMute spawn amixer sset Master mute
herbstclient keybind XF86MonBrightnessDown spawn $SHELL -c "brightness=\$(</sys/class/backlight/intel_backlight/brightness); new_brightness=\$((-$MAX_BRIGHTNESS/10+\$brightness)); actual_brightness=\$((\$new_brightness > 0 ? \$new_brightness : 0)); echo \$actual_brightness > /sys/class/backlight/intel_backlight/brightness"
# TODO alter new brightness like: xsetroot -name \"brightness: \$((100 * \$actual_brightness / $MAX_BRIGHTNESS)) %\""
herbstclient keybind XF86MonBrightnessUp spawn $SHELL -c "brightness=\$(</sys/class/backlight/intel_backlight/brightness) ; new_brightness=\$(($MAX_BRIGHTNESS/10+\$brightness)) ; actual_brightness=\$((\$new_brightness < $MAX_BRIGHTNESS ? \$new_brightness : $MAX_BRIGHTNESS)) ; echo \$actual_brightness > /sys/class/backlight/intel_backlight/brightness"
herbstclient keybind Mod4+Escape and , spawn ssh-add -D , spawn i3lock -c \#000000
herbstclient keybind Mod4+o spawn $HOME/etc/suckless/abridor/abridor.lua
# TODO find running journalctl instance
herbstclient keybind Mod4+F12 spawn $TERMINALCMD --class journalctl -T journalctl -- journalctl -b -f -n 1000
# TODO: bind weechat like "$TERMINALCMD --class weechat -T weechat -- weechat"
herbstclient keybind Mod4+0 spawn $HOME/etc/suckless/fm0/fm0.lua
herbstclient keybind Mod4+Shift+F7 spawn kitty @ --to unix:@mykitty set-colors -a -c foreground='#424242' background='#f9f8f4' color0='#f9f8f4' color1='#e32791' color2='#488432' color3='#a25d0e' color4='#2c65b5' color5='#B062A7' color6='#27BBBE' color7='#999999' color8='#B8B8B8' color9='#9F1B66' color10='#325D23' color11='#71410A' color12='#1F477F' color13='#7B4474' color14='#1B8486' color15='#424242' cursor='#FC9520'
herbstclient keybind Mod4+F7 spawn kitty @ --to unix:@mykitty set-colors -a -c foreground='#e5e6e6' background='#1e1e1e' color0='#1e1e1e' color8='#515151' color1='#e32791' color9='#e566ad' color2='#30c798' color10='#6cd1b2' color3='#e3c472' color11='#e4cf98' color4='#6769e6' color12='#9091e6' color5='#e59fdf' color13='#e5b6e1' color6='#81d8d0' color14='#a2dcd7' color7='#969696' color15='#e5e6e6' cursor='#20bbfc'
herbstclient keybind Mod4+F9 spawn bluetoothctl connect 88:C6:26:F4:8A:90
herbstclient keybind Mod4+Shift+F9 spawn bluetoothctl disconnect 88:C6:26:F4:8A:90
herbstclient keybind XF86AudioPlay spawn strawberry --play-pause
herbstclient keybind XF86AudioNext spawn strawberry --next
herbstclient keybind XF86AudioPrev spawn strawberry --restart-or-previous
herbstclient keybind Print spawn flameshot gui -p /tmp
herbstclient keybind Mod4+Print spawn flameshot screen -c -p /tmp
herbstclient keybind Mod4+i spawn clipmenu -p Clipboard
herbstclient keybind Mod4+u spawn $SHELL -c "xdg-open \$(\\ls -1Qt ${CM_DIR}/clipmenu.5.${USER}/*\ * | xargs awk 1 | grep --only-matching --perl-regexp \"http(s?):\/\/[^ \\\"\(\)\<\>\]]*\" | uniq |rofi -dmenu -i -p 'open URL')"
herbstclient keybind Mod4+a spawn $SHELL -c "$TERMINALCMD -- tmux new-session -A -s \$(tmux list-clients -F \"#S\" | rofi -dmenu -i -p 'Attach to tmux session:')"
herbstclient keybind Mod4+b spawn xsetroot -solid '#1e1e1e'
herbstclient keybind Mod4+Shift+b spawn $SHELL -c "xsetroot -bitmap $HOME/etc/suckless/backdrops/\`\\ls $HOME/etc/suckless/backdrops | shuf -n 1 | tr -d '\\n' | tee -a /tmp/wallpaper\` \`printf -- \" -fg #%06x -bg #%06x\\n\" \$(shuf -i0-16777215 -n2) | tee -a /tmp/wallpaper\`"
herbstclient keybind Mod4+numbersign toggle always_show_frame

# TODO xsetroot -name "$(cat ${CM_DIR}/clipmenu.5.${USER}/line_cache_* | sort | tail --lines=1 | cut -d ' ' -f 2- -- -)"

# basic movement
# focusing clients
herbstclient keybind Mod4-Left  focus left
herbstclient keybind Mod4-Down  focus down
herbstclient keybind Mod4-Up    focus up
herbstclient keybind Mod4-Right focus right

# moving clients
herbstclient keybind Mod4-Shift-Left  shift left
herbstclient keybind Mod4-Shift-Down  shift down
herbstclient keybind Mod4-Shift-Up    shift up
herbstclient keybind Mod4-Shift-Right shift right

# splitting frames
# create an empty frame at the specified direction
herbstclient keybind Mod4-d       split   bottom  0.5
herbstclient keybind Mod4-r       split   right   0.5
# let the current frame explode into subframes
herbstclient keybind Mod4-Control-space split explode

# resizing frames
resizestep=0.05
herbstclient keybind Mod4-Control-Left    resize left +$resizestep
herbstclient keybind Mod4-Control-Down    resize down +$resizestep
herbstclient keybind Mod4-Control-Up      resize up +$resizestep
herbstclient keybind Mod4-Control-Right   resize right +$resizestep

herbstclient rename default '!'
herbstclient add '!'
herbstclient load '!' '(clients max:0)'
herbstclient add '@'
herbstclient load '@' '(split horizontal:0.638200:0 (clients max:1) (split vertical:0.380500:1 (clients max:0) (clients max:0)))'
herbstclient add '#'
herbstclient load '#' '(clients grid:0)'
herbstclient add '$'
herbstclient load '$' '(clients max:0)'
herbstclient add '%'
herbstclient load '%' '(split horizontal:0.550000:0 (clients max:0) (clients max:0))'
herbstclient add '^'
herbstclient keybind Mod4-1 use_index 0
herbstclient keybind Mod4-2 use_index 1
herbstclient keybind Mod4-3 use_index 2
herbstclient keybind Mod4-4 use_index 3
herbstclient keybind Mod4-5 use_index 4
herbstclient keybind Mod4-6 use_index 5
herbstclient keybind Mod4-Shift-1 move_index 0
herbstclient keybind Mod4-Shift-2 move_index 1
herbstclient keybind Mod4-Shift-3 move_index 2
herbstclient keybind Mod4-Shift-4 move_index 3
herbstclient keybind Mod4-Shift-5 move_index 4
herbstclient keybind Mod4-Shift-6 move_index 5

# cycle through tags
herbstclient keybind Mod4-period use_index +1 --skip-visible
herbstclient keybind Mod4-comma  use_index -1 --skip-visible

# layouting
herbstclient keybind Mod4-w remove
herbstclient keybind Mod4-e split explode
herbstclient keybind Mod4-s split explode 0.356
herbstclient keybind Mod4-f floating toggle
herbstclient keybind Mod4-F11 fullscreen toggle
herbstclient keybind Mod4-t pseudotile toggle

herbstclient keybind Mod4-space or , and . compare tags.focus.curframe_wcount = 2 . cycle_layout +1 max grid max horizontal vertical , cycle_layout +1 max grid horizontal

# mouse
herbstclient mouseunbind --all
herbstclient mousebind Mod4-Button1 move
herbstclient mousebind Mod4-Button2 zoom
herbstclient mousebind Mod4-Button3 resize

# focus
herbstclient keybind Mod4-BackSpace cycle_monitor
herbstclient keybind Mod4-j         cycle_all --skip-invisible +1
herbstclient keybind Mod4-k         cycle_all --skip-invisible -1
herbstclient keybind Mod4-Tab       cycle +1
herbstclient keybind Mod4-Shift-Tab cycle -1
# herbstclient keybind Mod4-i         jumpto urgent

# rules
herbstclient unrule -F
#herbstclient rule class=XTerm tag=3 # move all xterms to tag 3
herbstclient rule focus=on # normally focus new clients
#herbstclient rule focus=off # normally do not focus new clients
# give focus to most common terminals
#herbstclient rule class~'(.*[Rr]xvt.*|.*[Tt]erm|Konsole)' focus=on
herbstclient rule windowtype~'_NET_WM_WINDOW_TYPE_(DIALOG|UTILITY|SPLASH)' pseudotile=on
herbstclient rule windowtype='_NET_WM_WINDOW_TYPE_DIALOG' focus=on
herbstclient rule windowtype~'_NET_WM_WINDOW_TYPE_(NOTIFICATION|DOCK|DESKTOP)' manage=off
herbstclient rule class=mpv instance=gl tag='@' index='10' focus='on' switchtag='on'
herbstclient rule once class='Google-chrome' tag='@' index='00' focus='on' switchtag='on'
herbstclient rule class='discord' tag='^'
herbstclient rule class='TelegramDesktop' tag='^'

# unlock, just to be sure
herbstclient unlock

# do multi monitor setup here, e.g.:
# herbstclient set_monitors 1280x1024+0+0 1280x1024+1280+0
# or simply:
# herbstclient detect_monitors

# find the panel
panel=~/.config/herbstluftwm/panel.sh
[[ -x "$panel" ]] || panel=/etc/xdg/herbstluftwm/panel.sh
for monitor in $(herbstclient list_monitors | cut -d: -f1) ; do
    # start it on each monitor
    "$panel" $monitor &
done
